name: Roomba Competition CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  # ------------------------------------------------------------------
  # JOB 1: Simulation Engine & Compatibility
  # ------------------------------------------------------------------
  engine-test:
    name: üèóÔ∏è Engine & Samples
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - name: Build Library (Sanitizer)
        run: make -C . lib-competition CFLAGS="-fsanitize=address -g -O1 -fno-omit-frame-pointer"

      - name: Smoke Test - Physics Engine
        working-directory: competition
        run: |
          # Create temp robot (50 ticks)
          cat <<EOF > test_robot.c
          #include "../simula.h"
          #include <stdio.h>
          void start() { int x,y; rmb_awake(&x, &y); printf("DEBUG: Robot started at %d,%d\n", x,y); }
          void beh() {}
          void stop() {}
          int main() {
             setbuf(stdout, NULL);
             printf("DEBUG: Configuring robot...\n");
             configure(start, beh, stop, 50);
             printf("DEBUG: Starting run loop...\n");
             run();
             printf("DEBUG: Run finished successfully.\n");
             return 0;
          }
          EOF
          # Compile & Run (with verbose timeout protection)
          gcc -fsanitize=address -g -O1 -fno-omit-frame-pointer -DCOMPETITION_MODE -I.. test_robot.c lib/simula.o -lm -o test_simula
          # Use explicit map to avoid random generation hangs
          timeout 10s ./test_simula ../maps/noobs.pgm

      - name: Validate Samples Compatibility
        run: |
          echo "Validating sample compilation..."
          find samples -name "*.c" -print0 | while IFS= read -r -d '' file; do
            echo "Compiling $file..."
            gcc -DCOMPETITION_MODE -I. "$file" competition/lib/simula.o -lm -o /dev/null
            if [ $? -ne 0 ]; then
              echo "::error::Failed to compile sample: $file"
              exit 1
            fi
          done

  # ------------------------------------------------------------------
  # JOB 2: Competition System (Runner & Score)
  # ------------------------------------------------------------------
  competition-test:
    name: üèÅ Runner & Score
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - name: Test Runner (Sanitizer + Smoke)
        working-directory: competition
        run: |
          # Build Runner Sanitized
          make debug-asan || gcc runner.c -fsanitize=address -g -O1 -fno-omit-frame-pointer -Wall -Wextra -lm -I../tools -o runner
          
          # Setup dummy team
          mkdir -p teams/ci_test
          cp ../templates/main.c teams/ci_test/main.c
          echo "0 0" > teams/ci_test/config.txt
          
          # Run Fast Test
          ./runner --team=ci_test --test
          
          # Verify
          if [ ! -f ranking.txt ]; then
            echo "Error: runner ranking.txt not generated"
            exit 1
          fi

      - name: Test Score System (Sanitizer)
        working-directory: competition
        run: |
          make score-asan
          echo "team,map_type,cell_total,cell_visited,dirt_total,dirt_cleaned,bat_total,bat_mean,forward,turn,bumps,clean,load" > ci_stats.dat
          echo "teamCI,0,100,50,20,10,500.0,10.0,100,50,5,10,0" >> ci_stats.dat
          
          ./score --stats ci_stats.dat
          
          if [ ! -f results/ranking.txt ]; then
            echo "Error: Scoring system failed"
            exit 1
          fi

  # ------------------------------------------------------------------
  # JOB 3: Tools Ecosystem
  # ------------------------------------------------------------------
  tools-test:
    name: üõ†Ô∏è Tools Suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - name: Build Tools (Sanitizer)
        run: make -C tools tools-asan

      - name: Prepare Clean Lib for Validate
        run: |
          # Validate compiles student code without sanitizers, so it needs a clean simula.o
          # Use 'make lib' to build standard simula.o without cleaning previously built tools
          make lib

      - name: Test Generate & Viewmap
        working-directory: tools
        run: |
          ./generate
          if [ ! -f maps/random1.pgm ]; then echo "::error::Generate failed"; exit 1; fi
          ./viewmap maps/random1.pgm

      - name: Test Myscore
        working-directory: tools
        run: |
          # Create valid dummy stats with all required columns
          echo "team,map_type,cell_total,cell_visited,dirt_total,dirt_cleaned,bat_total,bat_mean,forward,turn,bumps,clean,load" > dummy.csv
          echo "teamTool,0,100,50,20,10,500.0,10.0,100,50,5,10,0" >> dummy.csv
          
          # Debug: show content
          cat dummy.csv
          
          ./myscore dummy.csv

      - name: Test Validate (Setup)
        run: |
          # Create valid team structure for validate tool
          mkdir -p competition/teams/ci_test
          cp templates/main.c competition/teams/ci_test/main.c
          echo "0 0" > competition/teams/ci_test/config.txt

      - name: Test Validate (Run)
        working-directory: tools
        run: |
          # Validate expects maps directory
          ./validate ../competition/teams/ci_test --maps maps --timeout 5
